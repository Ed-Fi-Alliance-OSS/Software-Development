# Evaluating Cloud-based CI

**Contents**

- [Introduction](#introduction)
- [Architectural Requirements](#architectural-requirements)
- [Cost Evaluation](#cost-evaluation)
- [Evaluation of Providers](#evaluation-of-providers)

# Introduction

**_As an open source developer working on an Ed-Fi project, I want to know if my
pull request passes all standard quality checks, and I want to be able to review
any errors, so that I can correct my code with minimal intervention from Ed-Fi
staff and contractors._**

## Challenges

There are three key challenges when contemplating use of the existing Ed-Fi
TeamCity environment:

1. Server security: provisioning access to the environment.
2. Competition for scarce compute resources.

### Server Security / Access

The Ed-Fi TeamCity server is hosted on the dell.org network and requires VPN
access. The Alliance provides VPN access to contractors with only low overhead
to doing so. However, with the move to the Apache license we are beginning to
have more contributions from outside developers. Providing VPN access management
to these developers is not ideal. Furthermore, the Alliance and MSDF are
prioritizing creation of a number of new starter kits in Q4 of 2020 and all of 2021.
While some of these will be created under contract, the sheer number makes
it undesirable to manage VPN connections.

### Competition

Every additional project on the existing TeamCity environment increases the
likelihood of bottlenecks occurring, thus slowing down the development work on
the core Ed-Fi Alliance development teams.

## Goals of this document

- Document requirements for open source build automation.
- Survey a variety of platforms.
- Recommend one or more options to evaluate.

# Architectural Requirements

These high-level requirements are described in more detail below:

1. Source-controlled configuration
2. Support for languages used in Ed-Fi applications: .NET Core, Node.js, Python
3. Ability to run custom build scripts (PowerShell, Node.js, Python)
4. Read-only and power user support
5. Triggering and process security
6. Optional: integration testing support.
   1. Run integration testing with an integrated test harness
   2. Database support
7. Optional: self-hosting

## Source-Controlled Configuration

Could be Kotlin, YAML. Preferably in same repository as the code being built,
but not that is not absolutely essential.

## Languages

As of November 2020, the Ed-Fi Alliance development teams are writing code in,
and prefer to support (in descending order):

- .NET Core 3
- Node.js 12
- Python 3.8

## Build Scripts

Build scripts ensure that developers can run the same commands locally that are
run in the CI environment. In addition, they reduce the coupling to the CI
environment, thus making it easier to switch from one platform to another if
driven by cost and/or reliability.

## Read Only and Power Users

Ideally, any Internet user would be able to see the status of a build, and the
details of a build failure, for open source projects. Although build
configurations will be source-code driven, it will be necessary to have "power
users" who can setup the new build configurations and potentially access more
detailed information than is available to the read-only users.

## Triggering on Branches and Pull Requests

Any system needs to be easily configured for appropriate build triggers on
the `main`  branch and pull requests, and these triggers needs to be securable.

Build processes run build scripts. What happens when a malicious user modifies a
script to take malicious action? With automated builds running on all pull
requests, there is a high-impact risk that such a user could wreak havoc on the
build process, potentially including escalation attacks that allow the user to
gain full access to the operating system.

## Optional: Integration Testing Support

The ODS/API has a full suite of integration tests - in fact, there are three of
them:

- Long-running integration tests written in C# / NUnit
- End-to-end tests written in Postman
- End-to-end smoke tests.

Each of these needs access to a pristine database. Running them on a Cloud
provider seems unlikely unless the deployment and execution is orchestrated
through a linked Ed-Fi-managed cloud-based VM.

## Optional: Secure Credentials

In this initial evaluation we are not considering completely replacing the
MSDF-hosted TeamCity, Octopus Deploy, and testing VM's. Therefore we are not
concerned with pushing NuGet and other packages to repositories - and do not
need to store passwords / tokens for doing so. However, with the optional
possibility for managing deployments of some sort, secure credentials will
become a necessity. This feature will also be a necessity if we ever do choose
to make a full migration to the cloud provider, therefore it is useful to
document that now even if not needed.

## Optional: Self-Hosting

Being able to run the platform tool on a localhost or a VM can be helpful in
reducing the cycle time and cost for development of the build configurations and
even for the full lifecycle of application support.

## Optional: Multi-Repo Support

The ODS Platform build still require multiple repositories: ODS and
ODS-Implementation. Some (most?) platforms won't support this. However, this is
listed as optional since most of the broader development efforts do not involve
changes to the ODS/API or its tools.

## Optional: GitHub Status Check

Reporting the build status back to GitHub is a great feature, and almost makes
the cut as a required feature.

# Cost Evaluation

Cost containment is one of the reasons for the "read only" vs. "power users"
descriptions above - there are too many people in the Ed-Fi community for us to
pay for them to all have accounts.

Some of these providers have free accounts for open source projects, with a
certain number of build minutes available. Most likely these limits are too low
for our primary Ed-Fi projects, but they might suffice for smaller projects such
as a Starter Kit.

For comparison's sake: the Alliance is currently paying approximately $1,500 per
year for TeamCity licenses ($125/month) with support for eight concurrent jobs.
MSDF is paying for the Virtual Machines and IT maintenance without a direct bill
to the Alliance.

# Evaluation of Providers

## AppVeyor, CircleCi, and TravisCi

| Feature                 | AppVeyor                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | CircleCI                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | TravisCI                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Cost and Open Source    | Open Source<br><br>- 1 concurrent job ![(warning)](../../images/Continuous-Integration/warning.png)<br> <br>- Community support<br>- Unlimited public projects<br><br>Basic<br><br>- $29/month (or $14.50 for FOSS)<br>- 1 private project<br>- Priority support<br><br>Pro<br><br>- $59/month ($29.50 FOSS) <br>- Unlimited private projects<br><br>Premium<br><br>- $99/month ($49.50 FOSS)<br>\- 2 concurrent jobs<br><br>$50/month extra per additional concurrent job ($25/month for FOSS)<br><br>[pricing](https://www.appveyor.com/pricing/) | Free<br><br>- 2,500 credits/week<br>- FOSS plans get 400,000 credits on Linux <br>- Windows VM<br>- 1 concurrent job<br>- Community support<br><br>Performance<br><br>- ![(error)](../../images/Continuous-Integration/error.png)  $15/month for first 3 users, $15/month additional user. "Any user who commits code changes on a project"<br><br> Credits are parceled out based on VM size and type and are per minute. So a Medium Linux VM (smallest size) is 10 credits/minute. Thus FOSS plan 40,000 minutes, which is approximately 28 days of continuous single-threaded availability.<br><br><br><br><br><br><br><br><br><br><br> | TravisCI has made significant changes in October and November of 2020 and the level of support for open source projects is not clearly documented. They say they support but it is not what it used to be. <br><br>[One blogger's take](https://www.jeffgeerling.com/blog/2020/travis-cis-new-pricing-plan-threw-wrench-my-open-source-works) is pretty grim.<br><br>[Official announcement](https://blog.travis-ci.com/2020-11-02-travis-ci-new-billing) does have some details: looks like 1000 minutes / month on Linux unless you get special approval for more.<br><br>Going to stop the evaluation here for now based on this.<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br> |
| ​Configuration Language | appveyor.yml in the root of the repo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | ​                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | ​                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| .NET Core 3+            | ![(tick)](../../images/Continuous-Integration/check.png)<br><br> VS2019, .NET Core SDK 3.1.404, .NET 5 SDK 5.0.100                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Node.js 12+             | ![(tick)](../../images/Continuous-Integration/check.png)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Python 3.8+             | ![(tick)](../../images/Continuous-Integration/check.png)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| PowerShell              | ![(tick)](../../images/Continuous-Integration/check.png)<br><br> PS Core 7.1                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Other Tools             | NUnit3, [more](https://www.appveyor.com/docs/windows-images-software/)                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Triggering and security | ![(warning)](../../images/Continuous-Integration/warning.png) yes, can [configure triggering](https://www.appveyor.com/docs/branches/), however I have not found documentation on limiting the triggers.                                                                                                                                                                                                                                                                                                                                            | [Triggering trusted CI jobs on untrusted forks](https://circleci.com/blog/continuous-integration-for-go-applications/)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Read-only Users         | ![(tick)](../../images/Continuous-Integration/check.png) Can see full console output log, same as signed-in users. [Example](https://ci.appveyor.com/project/stephenfuqua/flightnode-api/builds/29401804).<br><br>![(warning)](../../images/Continuous-Integration/warning.png) In both cases, requires good console logging. Does not have same level of detail on job steps as TeamCity.                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Power/Admin Users       | ![(tick)](../../images/Continuous-Integration/check.png)<br>- detailed access to the project settings including UI-only settings<br>- Can re-run a build<br>- Can link to GitHub Teams                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Integration Testing     | ![(tick)](../../images/Continuous-Integration/check.png)  [services and databases](https://www.appveyor.com/docs/services-databases/)<br><br>Database Support<br><br>- SQL Server 2017 and 2019<br>- PostgreSQL 9 through 12<br><br>Deployment Support<br><br>- Octopus, Azure, AWS tool kits                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Secure Credentials      | ![(tick)](../../images/Continuous-Integration/check.png)  [secure variables](https://www.appveyor.com/docs/build-configuration/#secure-variables)                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Self-Hosting            | Free [Team Edition](https://www.appveyor.com/self-hosted/) looks adequate                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Multi-repo              | ![(tick)](../../images/Continuous-Integration/check.png)  [yes](https://help.appveyor.com/discussions/problems/2337-multiple-git-repos-in-one-project)                                                                                                                                                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| GH Status               | ![(tick)](../../images/Continuous-Integration/check.png) "... [can update](https://github.com/marketplace/appveyor) the build status on your GitHub pull requests"                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |

## TeamCity Cloud, Jenkins CloudBees

| Feature                 | TeamCity | CloudBees |     |
| ----------------------- | -------- | --------- | --- |
| Cost and Open Source    |          |           |     |
| ​Configuration Language | ​        | ​         | ​   |
| .NET Core 3+            |          |           |     |
| Node.js 12+             |          |           |     |
| Python 3.8+             |          |           |     |
| PowerShell              |          |           |     |
| Triggering and security |          |           |     |
| Read-only Users         |          |           |     |
| Power/Admin Users       |          |           |     |
| Integration Testing     |          |           |     |
| Secure Credentials      |          |           |     |
| Self-Hosting            |          |           |     |
| Multi-repo              |          |           |     |
| GH Status               |          |           |     |

## GitHub Actions, Azure DevOps, and AWS Whatever

| Feature                 | GitHub<br><br>[Proof of concept](./github-actions-poc.md)                                                                                                                                                                                                                                   | Azure | AWS |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----- | --- |
| Cost and Open Source    | - Free for public repositories<br>- 2,000 free minutes for private repositories (can pay for additional minutes)<br>- 20 concurrent jobs<br>- 1000 API requests/hour *within a repository*                                                                                                  |       |     |
| ​Configuration Language | ​ci.yml file<br><br>Extensive public actions are available but there are [legitimate security concerns](https://news.ycombinator.com/item?id=21844805).<br><br>[3rd party recommendations for security](https://humanwhocodes.com/blog/2020/07/safely-use-github-actions-in-organizations/) | ​     | ​   |
| .NET Core 3+            | ![(tick)](../../images/Continuous-Integration/check.png) Visual Studio 2019, every SDK version                                                                                                                                                                                              |       |     |
| Node.js 12+             | ![(tick)](../../images/Continuous-Integration/check.png)                                                                                                                                                                                                                                    |       |     |
| Python 3.8+             | ![(tick)](../../images/Continuous-Integration/check.png) [Windows 2019 VM](https://github.com/actions/virtual-environments/blob/main/images/win/Windows2019-Readme.md) has Python 3.7.9 as the default but appears to also have newer versions                                              |       |     |
| PowerShell              | ![(tick)](../../images/Continuous-Integration/check.png) 7.0.3 on both Windows and Linux!                                                                                                                                                                                                   |       |     |
| Triggering and security | ![(warning)](../../images/Continuous-Integration/warning.png) Have not been able to find clear documentation on this yet.                                                                                                                                                                   |       |     |
| Read-only Users         | ![(tick)](../../images/Continuous-Integration/check.png) general public can access status and logs. Example from [dotnet runtime](https://github.com/dotnet/runtime/runs/1236942735?check_suite_focus=true).                                                                                |       |     |
| Power/Admin Users       | ![(tick)](../../images/Continuous-Integration/check.png) GitHub organization members                                                                                                                                                                                                        |       |     |
| Integration Testing     | ![(tick)](../../images/Continuous-Integration/check.png) Has PostgreSQL 13                                                                                                                                                                                                                  |       |     |
| Secure Credentials      | ![(tick)](../../images/Continuous-Integration/check.png) [Encrypted secrets](https://docs.github.com/en/free-pro-team@latest/actions/reference/encrypted-secrets)                                                                                                                           |       |     |
| Self-Hosting            | ![(warning)](../../images/Continuous-Integration/warning.png) Via GitHub Enterprise, which is probably more than most people want to take on                                                                                                                                                |       |     |
| Multi-repo              | ![(tick)](../../images/Continuous-Integration/check.png) has git access, so can always script the build to clone another repo.                                                                                                                                                              |       |     |
| GH Status               | ![(tick)](../../images/Continuous-Integration/check.png) yes                                                                                                                                                                                                                                |       |     |
